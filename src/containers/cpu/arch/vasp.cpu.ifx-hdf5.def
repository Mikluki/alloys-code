Bootstrap: docker
From: ubuntu:22.04

%labels
    Author mklk
    Version VASP_CPU_INTEL_LLVM
    Description Clean VASP CPU container with Intel oneAPI HPC Toolkit (LLVM compilers) and Intel MKL
    Target_CPU Intel_Xeon_Gold_6140_Skylake_SP_AVX512

%files
    src/vasp.6.4.3.tgz /opt/vasp.6.4.3.tgz
    src/makefile.include.cpu.ifx /opt/makefile.include

%environment
    # Intel oneAPI environment (avoid setvars.sh for performance)
    export ONEAPI_ROOT=/opt/intel/oneapi
    
    # Intel MKL environment
    export MKLROOT=/opt/intel/oneapi/mkl/latest
    export LD_LIBRARY_PATH=/opt/intel/oneapi/mkl/latest/lib:$LD_LIBRARY_PATH
    
    # Intel Compiler environment
    export INTEL_COMPILER_ROOT=/opt/intel/oneapi/compiler/latest
    export PATH=/opt/intel/oneapi/compiler/latest/bin:$PATH
    export LD_LIBRARY_PATH=/opt/intel/oneapi/compiler/latest/lib:$LD_LIBRARY_PATH
    
    # Intel MPI environment
    export I_MPI_ROOT=/opt/intel/oneapi/mpi/latest
    export PATH=/opt/intel/oneapi/mpi/latest/bin:$PATH
    export LD_LIBRARY_PATH=/opt/intel/oneapi/mpi/latest/lib:$LD_LIBRARY_PATH
    
    # HDF5 environment (built from source)
    export HDF5_ROOT=/opt/hdf5
    export LD_LIBRARY_PATH=/opt/hdf5/lib:$LD_LIBRARY_PATH
    
    # VASP paths
    export PATH=/opt/vasp/vasp.6.4.3/bin:$PATH

    # Compiler settings (Intel LLVM-based)
    export FC=mpiifx
    export F90=mpiifx
    export F77=mpiifx
    export CC=mpiicx
    export CXX=mpiicpx

    # Intel MPI settings optimized for Skylake-SP
    export I_MPI_PIN=1
    export I_MPI_PIN_DOMAIN=auto
    export I_MPI_FABRICS=shm:ofi
    
    # Performance settings for VASP on Skylake-SP
    export OMP_NUM_THREADS=1
    export MKL_NUM_THREADS=1
    export KMP_AFFINITY=compact,1,0

%post
    echo "=== Installing system packages ==="
    apt-get update && apt-get install -y \
        build-essential \
        csh \
        tcsh \
        curl \
        wget \
        tar \
        rsync \
        libfftw3-dev \
        zlib1g-dev \
        gawk \
        python3 \
        python3-pip \
        vim \
        git \
        cmake \
        unzip \
        libfabric1 \ # WARN: if abcsent breaks MPI
        libnuma-dev \
        man \
        file \
        lsb-release \
        ca-certificates \
        gpg \
        && apt-get clean \
        && rm -rf /var/lib/apt/lists/*

    echo "=== [1/3] Installing Intel oneAPI HPC Toolkit via APT ==="
    
    # Set up Intel oneAPI repository
    wget -O- https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB \
        | gpg --dearmor | tee /usr/share/keyrings/oneapi-archive-keyring.gpg > /dev/null
    
    echo "deb [signed-by=/usr/share/keyrings/oneapi-archive-keyring.gpg] https://apt.repos.intel.com/oneapi all main" \
        | tee /etc/apt/sources.list.d/oneAPI.list
    
    # Update package list
    apt-get update
    
    # Install Intel HPC Toolkit (includes compilers, MKL, MPI)
    echo "Installing Intel HPC Toolkit components..."
    apt-get install -y \
        intel-oneapi-compiler-fortran \
        intel-oneapi-compiler-dpcpp-cpp \
        intel-oneapi-mkl-devel \
        intel-oneapi-mpi-devel

    # Verify Intel installations
    echo "=== Verifying Intel oneAPI installation ==="
    
    # Check MKL
    if [ -f "/opt/intel/oneapi/mkl/latest/lib/intel64/libmkl_core.so" ]; then
        echo "✓ Intel MKL installed successfully"
    else
        echo "✗ Intel MKL installation failed"
        exit 1
    fi
    
    # Check Intel Fortran compiler (LLVM-based)
    if [ -f "/opt/intel/oneapi/compiler/latest/bin/ifx" ]; then
        echo "✓ Intel Fortran compiler (ifx - LLVM) installed successfully"
    else
        echo "✗ Intel Fortran compiler installation failed"
        exit 1
    fi
    
    # Check Intel MPI
    if [ -f "/opt/intel/oneapi/mpi/latest/bin/mpiifx" ]; then
        echo "✓ Intel MPI (LLVM wrappers) installed successfully"
    else
        echo "✗ Intel MPI installation failed"
        exit 1
    fi

    echo "=== [2/3] Building HDF5 from source with Intel compilers ==="
    
    # Set Intel environment manually (setvars.sh is bash-specific)
    export PATH="/opt/intel/oneapi/compiler/latest/bin:/opt/intel/oneapi/mpi/latest/bin:$PATH"
    export LD_LIBRARY_PATH="/opt/intel/oneapi/compiler/latest/lib:/opt/intel/oneapi/mpi/latest/lib:$LD_LIBRARY_PATH"
    export CC=icx
    export FC=ifx
    export CXX=icpx
    
    cd /tmp
    wget https://github.com/HDFGroup/hdf5/releases/download/hdf5_1.14.6/hdf5-1.14.6.tar.gz
    tar -xzf hdf5-1.14.6.tar.gz
    cd hdf5-1.14.6
    
    # Configure with Intel compilers
    ./configure \
        --prefix=/opt/hdf5 \
        --enable-fortran \
        --enable-shared \
        --enable-static \
        CC=icx \
        FC=ifx \
        CXX=icpx
        
    make -j$(nproc)
    make install
    
    # Verify HDF5 installation
    if [ -f "/opt/hdf5/lib/libhdf5_fortran.so" ]; then
        echo "✓ HDF5 built and installed successfully"
    else
        echo "✗ HDF5 build failed"
        exit 1
    fi
    
    # Cleanup
    cd /
    rm -rf /tmp/hdf5-*

    echo "=== [3/3] Setting up VASP source ==="
    mkdir -p /opt/vasp
    cd /opt/vasp
    tar -xzf /opt/vasp.6.4.3.tgz
    
    # Copy CPU-optimized makefile.include
    cp /opt/makefile.include /opt/vasp/vasp.6.4.3/makefile.include
    
    # Fix permissions for any user to read/execute
    chmod -R o+rX /opt/vasp/vasp.6.4.3/
    
    # Verify VASP source extraction
    if [ -d "/opt/vasp/vasp.6.4.3" ] && [ -f "/opt/vasp/vasp.6.4.3/makefile.include" ]; then
        echo "✓ VASP source extracted and makefile.include copied"
    else
        echo "✗ VASP setup failed"
        exit 1
    fi

    echo "=== Cleaning up installation files ==="
    rm -rf /opt/vasp.6.4.3.tgz /opt/makefile.include

    echo "=== CPU container build completed successfully ==="
    echo "Target CPU: Intel Xeon Gold 6140 (Skylake-SP with AVX-512)"

%runscript
    echo "=========================================="
    echo "  VASP CPU Container (Intel oneAPI LLVM)"
    echo "=========================================="
    echo ""
    echo "Environment loaded:"
    echo "  ✓ Intel Fortran Compiler (ifx - LLVM)"
    echo "  ✓ Intel C/C++ Compilers (icx/icpx - LLVM)"
    echo "  ✓ Intel oneAPI MKL"
    echo "  ✓ Intel MPI"
    echo "  ✓ HDF5 (built from source with Intel compilers)"
    echo "  ✓ VASP 6.4.3 source ready"
    echo ""
    echo "Optimized for: Intel Xeon Gold 6140 (Skylake-SP + AVX-512)"
    echo ""
    echo "To compile VASP (copy to writable location first):"
    echo "  # Bind mount a working directory:"
    echo "  singularity exec --bind ./work:/work container.sif bash -c \\"
    echo "    'cp -r /opt/vasp/vasp.6.4.3 /work/ && cd /work/vasp.6.4.3 && make DEPS=1 -j\$(nproc)'"
    echo ""
    echo "VASP source location: /opt/vasp/vasp.6.4.3"
    echo "Makefile template:    /opt/vasp/vasp.6.4.3/makefile.include"
    echo ""
