#!/bin/bash

# vsf-gnn-merge - Merge updated JSONs from GNN processing back to original structure
# Usage: vsf-gnn-merge /path/to/structures
# Usage: vsf-gnn-merge cat-test/*/

gnn_merge() {
    set -euo pipefail

    # Check if fd is available
    if ! command -v fd >/dev/null 2>&1; then
        echo "ERROR: 'fd' command not found. Please install fd-find."
        echo "Ubuntu/Debian: sudo apt install fd-find"
        echo "             : cargo install fd-find"
        echo "macOS: brew install fd"
        return 1
    fi

    # Colors for output
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    NC='\033[0m' # No Color

    # Function to print colored output
    print_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
    print_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
    print_error() { echo -e "${RED}[ERROR]${NC} $1"; }
    print_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }

    # Function to log messages
    log_message() {
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
    }

    # Function to process a single directory
    process_directory() {
        local SOURCE_DIR="$1"
        local TARGET_DIR="$2"
        local MERGE_MODE="$3"

        SOURCE_NAME=$(basename "$SOURCE_DIR")
        TARGET_NAME=$(basename "$TARGET_DIR")

        # Use log/ directory if it exists, otherwise write to cwd
        if [[ -d "log" ]]; then
            LOG_FILE="log/${SOURCE_NAME}-to-${TARGET_NAME}-gnnmerge.log"
        else
            LOG_FILE="${SOURCE_NAME}-to-${TARGET_NAME}-gnnmerge.log"
        fi

        # Validate directories
        if [[ ! -d "$SOURCE_DIR" ]]; then
            print_error "Source directory does not exist: $SOURCE_DIR"
            return 1
        fi

        if [[ ! -d "$TARGET_DIR" ]]; then
            print_error "Target directory does not exist: $TARGET_DIR"
            return 1
        fi

        # Check that source and target are different
        if [[ "$SOURCE_DIR" == "$TARGET_DIR" ]]; then
            print_error "Source and target directories are the same: $SOURCE_DIR"
            return 1
        fi

        print_info "Processing merge"
        if [[ "$MERGE_MODE" == "false" ]]; then
            print_warn "DRY RUN MODE - No files will be modified"
        fi
        print_info "Source: $SOURCE_DIR"
        print_info "Target: $TARGET_DIR"
        print_info "Log: $LOG_FILE"

        # Initialize log file
        if [[ "$MERGE_MODE" == "false" ]]; then
            echo "GNN Merge Log [DRY RUN] - $(date)" > "$LOG_FILE"
            log_message "[DRY RUN] Starting merge operation: $SOURCE_DIR -> $TARGET_DIR"
        else
            echo "GNN Merge Log - $(date)" > "$LOG_FILE"
            log_message "Starting merge operation: $SOURCE_DIR -> $TARGET_DIR"
        fi
        log_message "Using fd for file operations (ignoring .gitignore)"

        # Counters
        local json_merged=0
        local json_skipped=0

        print_info "Scanning for JSON files to merge..."

        # Find all JSON files in source directory (ignore .gitignore)
        local json_files
        mapfile -t json_files < <(fd -e json -I . "$SOURCE_DIR")

        print_info "Found ${#json_files[@]} JSON files to process"

        # Process each JSON file
        for json_file in "${json_files[@]}"; do
            # Get relative path from source directory
            local rel_path="${json_file#$SOURCE_DIR/}"
            local target_file="$TARGET_DIR/$rel_path"
            local target_dir=$(dirname "$target_file")
            
            # Ensure target directory exists
            if [[ ! -d "$target_dir" ]]; then
                print_warn "Target directory does not exist: $target_dir"
                log_message "Warning: Target directory missing for $rel_path"
                ((json_skipped++))
                continue
            fi
            
            # Copy JSON file (or simulate in dry-run mode)
            if [[ "$MERGE_MODE" == "false" ]]; then
                print_info "[DRY RUN] Would merge: $rel_path"
                log_message "[DRY RUN] Would merge JSON: $rel_path"
            else
                cp "$json_file" "$target_file"
                log_message "Merged JSON: $rel_path"
            fi
            ((json_merged++))
        done

        # Count verification - compare target vs source JSON counts
        print_info "Performing count verification..."

        # Count JSONs (ignore .gitignore)
        local target_json_count source_json_count
        target_json_count=$(fd -e json -I . "$TARGET_DIR" | wc -l)
        source_json_count=$(fd -e json -I . "$SOURCE_DIR" | wc -l)

        # Verification results
        print_info "=== COUNT VERIFICATION ==="
        print_info "Target directory JSONs: $target_json_count"
        print_info "Source directory JSONs: $source_json_count"
        print_info "JSONs merged:           $json_merged"

        # Check for discrepancies
        if [[ $source_json_count -ne $json_merged ]]; then
            local discrepancy=$((source_json_count - json_merged))
            print_warn "Discrepancy detected: $discrepancy JSON(s) not merged"
            log_message "Warning: Discrepancy - Source: $source_json_count, Merged: $json_merged"
        fi

        # Print detailed summary
        if [[ "$MERGE_MODE" == "false" ]]; then
            print_success "[DRY RUN] Merge simulation completed"
        else
            print_success "Merge operation completed"
        fi
        echo
        print_info "=== DETAILED SUMMARY ==="
        print_info "JSON files processed: ${#json_files[@]}"
        if [[ "$MERGE_MODE" == "false" ]]; then
            print_info "JSON files that would be merged: $json_merged"
        else
            print_info "JSON files merged: $json_merged"
        fi

        if [[ $json_skipped -gt 0 ]]; then
            print_warn "JSON files skipped:   $json_skipped"
        fi

        # Final status check
        local success_status=0
        if [[ $json_skipped -eq 0 ]]; then
            if [[ "$MERGE_MODE" == "false" ]]; then
                print_success "[DRY RUN] All JSON files would be merged successfully!"
                log_message "[DRY RUN] Merge simulation completed - All files would be processed"
            else
                print_success "All JSON files successfully merged!"
                log_message "Merge completed successfully - All files processed"
            fi
        else
            print_warn "Merge completed with warnings - check log for details"
            if [[ "$MERGE_MODE" == "false" ]]; then
                log_message "[DRY RUN] Merge simulation completed with issues - Would skip: $json_skipped"
            else
                log_message "Merge completed with issues - Skipped: $json_skipped"
            fi
            success_status=1
        fi

        # Log final summary
        if [[ "$MERGE_MODE" == "false" ]]; then
            log_message "[DRY RUN] Merge summary - Processed: ${#json_files[@]}, Would merge: $json_merged, Would skip: $json_skipped"
        else
            log_message "Merge summary - Processed: ${#json_files[@]}, Merged: $json_merged, Skipped: $json_skipped"
        fi
        log_message "Count verification - Target: $target_json_count, Source: $source_json_count"

        print_info "Detailed log written to: $LOG_FILE"
        if [[ "$MERGE_MODE" == "false" ]]; then
            print_info "Use -m or --merge flag to actually merge files"
        fi

        echo "----------------------------------------"
        return $success_status
    }

    # Parse flags
    local MERGE_MODE=false
    local args=()
    
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -m|--merge)
                MERGE_MODE=true
                shift
                ;;
            *)
                args+=("$1")
                shift
                ;;
        esac
    done

    # Check arguments
    if [[ ${#args[@]} -ne 2 ]]; then
        print_error "Usage: $0 [-m|--merge] <source_directory> <target_directory>"
        print_error "Example: $0 cat-test-gnncp cat-test                  # Dry run (default)"
        print_error "Example: $0 --merge cat-test-gnncp cat-test          # Actually merge"
        print_error "Example: $0 -m cat-test-gnncp cat-test"
        print_error "Merges JSON files from source to target directory"
        exit 1
    fi

    local SOURCE_DIR="${args[0]}"
    local TARGET_DIR="${args[1]}"

    # Remove trailing slashes if present
    SOURCE_DIR="${SOURCE_DIR%/}"
    TARGET_DIR="${TARGET_DIR%/}"

    print_info "GNN Merge Script Starting"
    if [[ "$MERGE_MODE" == "false" ]]; then
        print_warn "Running in DRY RUN mode (default) - no files will be modified"
        print_warn "Use -m or --merge flag to actually merge files"
    else
        print_info "Running in MERGE mode - files will be modified"
    fi
    print_info "Merging: $SOURCE_DIR -> $TARGET_DIR"

    # Process the directory pair
    if process_directory "$SOURCE_DIR" "$TARGET_DIR" "$MERGE_MODE"; then
        if [[ "$MERGE_MODE" == "false" ]]; then
            print_success "[DRY RUN] Simulation completed successfully!"
        else
            print_success "Merge completed successfully!"
        fi
    else
        print_error "Merge failed!"
        exit 1
    fi
}

# Execute function with all arguments
gnn_merge "$@"
